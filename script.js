// ===============================
// Í∏àÏ¥åÍµêÌöå Ï≤≠ÎÖÑÎ∂Ä ¬∑ ÎîîÏßÄÌÑ∏ Ï£ºÎ≥¥
// ===============================

/**
 * ‚úÖ Îß§Ï£º ÏàòÏ†ïÌïòÎäî Í≥≥ (Ïó¨Í∏∞Îßå Î∞îÍæ∏Î©¥ Îê®)
 */
const WEEK_DATA = {
  weekBadge: "2026. 02. 01 (Ï£ºÏùº)",

  weekSubtitle: "ÌôòÏòÅÌï©ÎãàÎã§.\nÍ∏àÏ¥åÍµêÌöå Ï≤≠ÎÖÑÎ∂ÄÏûÖÎãàÎã§.",

  // ‚úÖ ÏòàÎ∞∞ ÏàúÏÑú
  orderItems: [
    {
      title: "ÏòàÎ∞∞Ïùò ÏãúÏûë",
      leader: "Îã§Í∞ôÏù¥",
      lines: ["ÏÇ¨ÎèÑÏã†Í≤Ω"],
      accordion: {
        summary: "ÏÇ¨ÎèÑÏã†Í≤Ω Ï†ÑÎ¨∏ Î≥¥Í∏∞",
        content:
`ÎÇòÎäî Ï†ÑÎä•ÌïòÏã† ÏïÑÎ≤ÑÏßÄ ÌïòÎÇòÎãò,
Ï≤úÏßÄÏùò Ï∞ΩÏ°∞Ï£ºÎ•º ÎØøÏäµÎãàÎã§.
ÎÇòÎäî Í∑∏Ïùò Ïú†ÏùºÌïòÏã† ÏïÑÎì§,
Ïö∞Î¶¨ Ï£º ÏòàÏàò Í∑∏Î¶¨Ïä§ÎèÑÎ•º ÎØøÏäµÎãàÎã§.
Í∑∏Îäî ÏÑ±Î†πÏúºÎ°ú ÏûâÌÉúÎêòÏñ¥
ÎèôÏ†ïÎÖÄ ÎßàÎ¶¨ÏïÑÏóêÍ≤åÏÑú ÎÇòÏãúÍ≥†,
Î≥∏ÎîîÏò§ ÎπåÎùºÎèÑÏóêÍ≤å Í≥†ÎÇúÏùÑ Î∞õÏïÑ
Ïã≠ÏûêÍ∞ÄÏóê Î™ª Î∞ïÌòÄ Ï£ΩÏúºÏãúÍ≥†,
Ïû•ÏÇ¨Îêú ÏßÄ ÏÇ¨ÌùòÎßåÏóê
Ï£ΩÏùÄ Ïûê Í∞ÄÏö¥Îç∞ÏÑú Îã§Ïãú ÏÇ¥ÏïÑÎÇòÏÖ®ÏúºÎ©∞,
ÌïòÎäòÏóê Ïò§Î•¥ÏãúÏñ¥ Ï†ÑÎä•ÌïòÏã† ÏïÑÎ≤ÑÏßÄ ÌïòÎÇòÎãò
Ïö∞Ìé∏Ïóê ÏïâÏïÑ Í≥ÑÏãúÎã§Í∞Ä,
Í±∞Í∏∞Î°úÎ∂ÄÌÑ∞ ÏÇ¥ÏïÑÏûàÎäî ÏûêÏôÄ
Ï£ΩÏùÄ ÏûêÎ•º Ïã¨ÌåêÌïòÎü¨ Ïò§Ïã≠ÎãàÎã§.
ÎÇòÎäî ÏÑ±Î†πÏùÑ ÎØøÏúºÎ©∞,
Í±∞Î£©Ìïú Í≥µÍµêÌöåÏôÄ ÏÑ±ÎèÑÏùò ÍµêÏ†úÏôÄ
Ï£ÑÎ•º Ïö©ÏÑú Î∞õÎäî Í≤ÉÍ≥º Î™∏Ïùò Î∂ÄÌôúÍ≥º
ÏòÅÏÉùÏùÑ ÎØøÏäµÎãàÎã§.
ÏïÑÎ©ò.`
      }
    },
    {
      title: "Ï∞¨ÏñëÍ≥º Í∏∞ÎèÑ",
      leader: "Ïù∏ÎèÑÏûê",
      lines: [
        { type: "link", text: "Ïù¥Î≤à Ï£º Ï∞¨Ïñë ÏïÖÎ≥¥ Î≥¥Í∏∞", href: "#praise" },
      ],
    },
    {
      title: "ÏÑ±Í≤ΩÎ¥âÎèÖ",
      leader: "Îã§ Í∞ôÏù¥",
      lines: ["Ìûà 11:1~2"],
      verse: [
        "1. ÎØøÏùåÏùÄ Î∞îÎùºÎäî Í≤ÉÎì§Ïùò Ïã§ÏÉÅÏù¥Ïöî Î≥¥Ïù¥ÏßÄ ÏïäÎäî Í≤ÉÎì§Ïùò Ï¶ùÍ±∞Îãà",
        "2. ÏÑ†ÏßÑÎì§Ïù¥ Ïù¥Î°úÏç® Ï¶ùÍ±∞Î•º ÏñªÏóàÎäêÎãàÎùº",
      ],
    },
    {
      title: "ÏÑ§Íµê",
      leader: "Ïã¨Í¥ëÏùº Î™©ÏÇ¨Îãò",
      lines: ["‚ÄúÏò®Ï†ÑÌïòÍ≤å ÌïòÏãúÎäî ÏòàÏàòÎãòÏùÑ Î≥¥Îùº‚Äù"],
    },
    {
      title: "Ï∂ïÎèÑ",
      leader: "Ïã¨Í¥ëÏùº Î™©ÏÇ¨Îãò",
      lines: [],
    },

    // ‚úÖ Ïö©Ïñ¥ Î≥ÄÍ≤Ω + ÌÅ¥Î¶≠ Ïãú Ï≤≠ÎÖÑÎ∂Ä ÏÜåÏãùÏúºÎ°ú Ïù¥Îèô
    {
      title: "ÏÜåÏãù Î∞è Í≥µÏßÄ",
      leader: "Î∞∞ÌÉúÏö± Ï≤≠ÎÖÑ",
      lines: [
        { type: "link", text: "Ïù¥Î≤à Ï£º Ï≤≠ÎÖÑÎ∂Ä ÏÜåÏãù Î≥¥Í∏∞", href: "#news" },
      ],
    },

    {
      title: "Î™©Ïû•Î™®ÏûÑ",
      leader: "Î™©Ïû•Î≥Ñ",
      lines: [],
    },
  ],

  // ‚úÖ ÏÜåÏãù ÎÇ¥Ïö©
  newsIntro: "Ïù¥Î≤à Ï£º Í≥µÏßÄ/ÏïàÎÇ¥ ÏÇ¨Ìï≠ÏûÖÎãàÎã§.",
  newsItems: [
    {
      title: "‚úÖ ÏàòÎ†®Ìöå Ï§ÄÎπÑ Í∏∞ÎèÑÌöå ÏïàÎÇ¥",
      body:
        "1.31(ÌÜ†) Ïò§Ï†Ñ 10Ïãú 30Î∂ÑÏóê ÏàòÎ†®Ìöå Ï§ÄÎπÑÎ•º ÏúÑÌïú ÎßàÏßÄÎßâ Ï§ÄÎπÑ Í∏∞ÎèÑÌöåÍ∞Ä ÏûàÏäµÎãàÎã§.\n" +
        "ÍµêÌöå ÎòêÎäî Í∞ÅÏûêÏùò ÏûêÎ¶¨ÏóêÏÑú ÏûêÏú†Î°≠Í≤å Ï∞∏Ïó¨Ìï¥Ï£ºÏÑ∏Ïöî.",
    },
    {
      title: "‚úÖ 2026 Ï≤≠ÎÖÑÎ∂Ä ÎèôÍ≥ÑÏàòÎ†®Ìöå Í≥µÏßÄ",
      body:
        "Ï£ºÏ†ú: Ïò®Ï†ÑÌïòÍ≤å ÌïòÏãúÎäî ÏòàÏàòÎ•º Î≥¥Îùº(Ìûà 11:1~2 / 12:1~2)\n" +
        "ÏùºÏãú: 2.6(Í∏à) ~ 2.7(ÌÜ†)\n" +
        "Ïû•ÏÜå: Ìï¥ÏïàÎÇ®Î°ú 1588-15 Î™®Îã¥Ïä§ÌÖåÏù¥(Í∞ïÌôîÎèÑ)\n" +
        "ÍµêÌöå ÏßëÌï© ÏãúÍ∞Ñ: 2.6(Í∏à) Ïò§ÌõÑ 12Ïãú(Ï≤≠ÎÖÑÎ∂Ä ÏòàÎ∞∞Ïã§Î°ú Î™®Ïù¥ÏÑ∏Ïöî)\n" +
        "ÌöåÎπÑ: 15,000Ïõê / ÏßÑÏÑ†ÎØº Ï≤≠ÎÖÑÏóêÍ≤å Ï†úÏ∂ú(Ïπ¥Ïπ¥Ïò§ÌéòÏù¥ Í∞ÄÎä•Ìï©ÎãàÎã§)\n" +
        "Î¨∏Ïùò: Ïã¨Í¥ëÏùº Î™©ÏÇ¨Îãò, Î∞∞ÌÉúÏö± Ï≤≠ÎÖÑ\n" +
        "üî•Ï£ºÏöî ÌîÑÎ°úÍ∑∏Îû®: Ï∞¨ÏñëÍ≥º ÏòàÎ∞∞, ÎààÏç∞Îß§, Í±¥ÏãùÏÇ¨Ïö∞ÎÇò, Í≥†Í∏∞ÌååÌã∞, Î∂àÎ©ç, ÎãåÌÖêÎèÑÏä§ÏúÑÏπò Îì±",
    },
  ],

  // ‚úÖ Ï∞¨Ïñë ÏïÖÎ≥¥ Ïù¥ÎØ∏ÏßÄ (assets Ìè¥Îçî)
  praiseFiles: [
    "assets/001.jpg",
    "assets/002.jpg",
    "assets/003.jpg",
    "assets/004.png",
  ],
};

// -------------------------------
// DOM
// -------------------------------
const prefersReduced = window.matchMedia("(prefers-reduced-motion: reduce)").matches;
const views = Array.from(document.querySelectorAll(".view"));

const sheet = document.getElementById("sheet");
const openMenuBtn = document.getElementById("openMenu");
const closeMenuBackdrop = document.getElementById("closeMenu");
const closeMenuBtn = document.getElementById("closeMenuBtn");
const topbar = document.querySelector(".js-topbar");

// content targets
const weekBadge = document.getElementById("weekBadge");
const weekSubtitle = document.getElementById("weekSubtitle");

const orderList = document.getElementById("orderList");

const newsIntro = document.getElementById("newsIntro");
const newsList = document.getElementById("newsList");

const praiseFeed = document.getElementById("praiseFeed");

// viewer
const viewer = document.getElementById("viewer");
const viewerRail = document.getElementById("viewerRail");
const viewerCounter = document.getElementById("viewerCounter");
const viewerCloseBg = document.getElementById("viewerCloseBg");
const viewerCloseBtn = document.getElementById("viewerCloseBtn");

// -------------------------------
// Scroll Motion (Home banners)
// -------------------------------
const scrollObserver = new IntersectionObserver((entries) => {
  entries.forEach((entry) => {
    if (entry.isIntersecting) {
      entry.target.classList.add("is-visible");
      scrollObserver.unobserve(entry.target);
    }
  });
}, { threshold: 0.12 });

function initScrollMotion() {
  document.querySelectorAll(".scroll-item").forEach((el) => {
    el.classList.remove("is-visible");
    scrollObserver.observe(el);
  });
}

// -------------------------------
// Topbar effect
// -------------------------------
window.addEventListener("scroll", () => {
  if (!topbar) return;
  if (window.scrollY > 18) topbar.classList.add("is-scrolled");
  else topbar.classList.remove("is-scrolled");
});

// -------------------------------
// Sheet menu open/close
// -------------------------------
function openSheet() {
  sheet?.classList.add("is-open");
  sheet?.setAttribute("aria-hidden", "false");
}
function closeSheet() {
  sheet?.classList.remove("is-open");
  sheet?.setAttribute("aria-hidden", "true");
}

openMenuBtn?.addEventListener("click", openSheet);
closeMenuBackdrop?.addEventListener("click", closeSheet);
closeMenuBtn?.addEventListener("click", closeSheet);

// -------------------------------
// Router
// -------------------------------
function hashToViewName(hash) {
  const clean = (hash || "").replace("#", "").trim();
  return clean || "home";
}

function showView(name) {
  views.forEach((v) => {
    const match = v.getAttribute("data-view") === name;
    v.classList.toggle("is-active", match);
  });

  if (!prefersReduced) window.scrollTo({ top: 0, behavior: "smooth" });
  else window.scrollTo(0, 0);

  if (name === "home") setTimeout(initScrollMotion, 60);
}

function route() {
  const name = hashToViewName(location.hash);
  const exists = views.some((v) => v.getAttribute("data-view") === name);

  if (!exists) {
    location.hash = "#home";
    return;
  }

  showView(name);
  closeSheet();
}

document.querySelectorAll("[data-route]").forEach((a) => {
  a.addEventListener("click", () => {
    const href = a.getAttribute("href");
    if (!href || !href.startsWith("#")) return;
    location.hash = href;
  });
});

document.querySelectorAll("[data-back]").forEach((btn) => {
  btn.addEventListener("click", () => {
    if (history.length > 1) history.back();
    else location.hash = "#home";
  });
});

window.addEventListener("hashchange", route);

// -------------------------------
// Render weekly content
// -------------------------------
function renderWeek() {
  // home header
  if (weekBadge) weekBadge.textContent = WEEK_DATA.weekBadge || "Ïù¥Î≤à Ï£º";
  if (weekSubtitle) weekSubtitle.innerHTML = (WEEK_DATA.weekSubtitle || "")
    .replaceAll("\n", "<br />");

  // ORDER
  if (orderList) {
    orderList.innerHTML = "";
    (WEEK_DATA.orderItems || []).forEach((item) => {
      const el = document.createElement("div");
      el.className = "orderItem";

      const head = `
        <div class="orderHead">
          <h3 class="orderTitle">${escapeHTML(item.title || "")}</h3>
          <div class="orderLeader">${escapeHTML(item.leader || "")}</div>
        </div>
      `;

      const bodyLines = (item.lines || []).map((line) => {
        if (typeof line === "object" && line.type === "link") {
          return `
            <p>
              <a class="orderLink" href="${escapeAttr(line.href || "#")}" data-route>
                ${escapeHTML(line.text || "")} <span aria-hidden="true">‚Üí</span>
              </a>
            </p>
          `;
        }
        return `<p>${escapeHTML(line || "")}</p>`;
      }).join("");

      const verseBlock = (item.verse && item.verse.length)
        ? `
          <div class="orderVerse">
            ${item.verse.map(v => `<p>${escapeHTML(v)}</p>`).join("")}
          </div>
        `
        : "";

      // ‚úÖ ÏïÑÏΩîÎîîÏñ∏(ÏÇ¨ÎèÑÏã†Í≤Ω Îì±)
      const accBlock = (item.accordion && item.accordion.content)
        ? `
          <details class="acc">
            <summary>${escapeHTML(item.accordion.summary || "ÎÇ¥Ïö© Î≥¥Í∏∞")}</summary>
            <div class="acc__body">
              <p>${formatMultiline(item.accordion.content)}</p>
            </div>
          </details>
        `
        : "";

      el.innerHTML = `
        ${head}
        <div class="orderBody">
          ${bodyLines}
          ${verseBlock}
          ${accBlock}
        </div>
      `;

      orderList.appendChild(el);
    });
  }

  // NEWS
  if (newsIntro) newsIntro.textContent = WEEK_DATA.newsIntro || "";
  if (newsList) {
    newsList.innerHTML = "";
    (WEEK_DATA.newsItems || []).forEach((n) => {
      const li = document.createElement("li");
      li.innerHTML = `
        <p class="bulletTitle">${escapeHTML(n.title || "")}</p>
        <p class="bulletBody">${formatMultiline(n.body || "")}</p>
      `;
      newsList.appendChild(li);
    });
  }

  // PRAISE
  if (praiseFeed) {
    praiseFeed.innerHTML = "";
    const files = WEEK_DATA.praiseFiles || [];

    files.forEach((src, idx) => {
      const card = document.createElement("div");
      card.className = "scoreCard";
      card.innerHTML = `
        <img class="scoreCard__img" src="${encodeURI(src)}" alt="ÏïÖÎ≥¥ ${idx + 1}" loading="lazy" />
        <div class="scoreCard__cap">ÏïÖÎ≥¥ ${idx + 1}</div>
      `;

      const img = card.querySelector("img");
      img?.addEventListener("click", () => openViewer(idx));

      praiseFeed.appendChild(card);
    });
  }

  // ensure data-route works inside rendered links
  document.querySelectorAll("[data-route]").forEach((a) => {
    a.addEventListener("click", () => {
      const href = a.getAttribute("href");
      if (!href || !href.startsWith("#")) return;
      location.hash = href;
    });
  });
}

// escape helpers
function escapeHTML(str){
  return String(str)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}
function escapeAttr(str){
  return String(str).replaceAll('"', "&quot;");
}
function formatMultiline(str){
  return escapeHTML(str).replaceAll("\n", "<br />");
}

// -------------------------------
// Fullscreen viewer (Ï¢åÏö∞ ÎÑòÍ∏∞Í∏∞)
// -------------------------------
let viewerFiles = [];

function openViewer(startIndex = 0) {
  viewerFiles = WEEK_DATA.praiseFiles || [];
  if (!viewer || !viewerRail || !viewerCounter) return;
  if (viewerFiles.length === 0) return;

  viewerRail.innerHTML = "";
  viewerFiles.forEach((src, i) => {
    const slide = document.createElement("div");
    slide.className = "viewer__slide";
    slide.innerHTML = `<img src="${encodeURI(src)}" alt="ÏïÖÎ≥¥ ÌÅ¨Í≤åÎ≥¥Í∏∞ ${i + 1}" />`;
    viewerRail.appendChild(slide);
  });

  viewer.classList.add("is-open");
  viewer.setAttribute("aria-hidden", "false");
  document.body.classList.add("is-locked");

  updateViewerCounter(startIndex);

  setTimeout(() => {
    const target = viewerRail.children[startIndex];
    target?.scrollIntoView({ behavior: "instant", inline: "start", block: "nearest" });
  }, 50);
}

function closeViewer() {
  if (!viewer) return;
  viewer.classList.remove("is-open");
  viewer.setAttribute("aria-hidden", "true");
  document.body.classList.remove("is-locked");
}

function updateViewerCounter(index) {
  if (!viewerCounter) return;
  viewerCounter.textContent = `${index + 1} / ${viewerFiles.length}`;
}

let rafId = null;
viewerRail?.addEventListener("scroll", () => {
  if (rafId) cancelAnimationFrame(rafId);
  rafId = requestAnimationFrame(() => {
    const w = viewerRail.clientWidth || 1;
    const idx = Math.round(viewerRail.scrollLeft / w);
    const safe = Math.max(0, Math.min(viewerFiles.length - 1, idx));
    updateViewerCounter(safe);
  });
});

viewerCloseBg?.addEventListener("click", closeViewer);
viewerCloseBtn?.addEventListener("click", closeViewer);

window.addEventListener("keydown", (e) => {
  if (e.key === "Escape") closeViewer();
});

// -------------------------------
// init
// -------------------------------
window.addEventListener("load", () => {
  if (!location.hash) location.hash = "#home";
  renderWeek();
  route();
  initScrollMotion();
});
